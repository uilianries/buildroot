#include <stdlib.h>
#include <string.h>
#include <stdio.h>

#include <wiringPi.h>
#include <wiringPiI2C.h>


#define BUFFER_SIZE (1024)


static int buffer[BUFFER_SIZE] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xc0,0xc0,0xe0,0xf0,0xf0,0xf8,0xfc,0xfe,0xfe,0xff,0xff,0xff,0xff,0xff,0xfe,0xfc,0xfc,0xf8,0xf0,0xf0,0xe0,0xc0,0xc0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xc0,0xc0,0xe0,0xf0,0xf8,0xf8,0xfc,0xfe,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0x06,0xfc,0xfc,0xf8,0xf0,0xf0,0xe0,0xc0,0xc0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0xf8,0xfc,0xfc,0xfe,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,0xfc,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,0xbf,0xbf,0xdf,0xef,0xef,0xf7,0xf7,0xfb,0x7d,0x7d,0x3e,0x7e,0x7f,0xfe,0xfe,0xfd,0xfd,0xfb,0xfb,0xf7,0xf7,0xef,0xef,0xdf,0xdf,0xbf,0xbf,0x7f,0xff,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7f,0x7f,0x7f,0x7f,0xbf,0xbf,0xdf,0xef,0xef,0xf7,0xfb,0xfb,0xfd,0xfd,0xfe,0xfe,0xff,0x1f,0x0f,0x03,0x03,0x01,0xf0,0xf0,0xfc,0xfc,0xfc,0xfc,0xfe,0xfe,0xfe,0xfe,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3f,0x3f,0x7f,0xfe,0xfe,0xfd,0xfd,0xfb,0xfb,0xf7,0xf7,0xef,0xef,0xdf,0xdf,0xbf,0xbf,0x7f,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0x0c,0x0f,0x1f,0x1f,0x3f,0x3f,0x7f,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,0xf8,0xf0,0xf0,0xe0,0xc3,0xc7,0xc7,0xcf,0x8f,0x8f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x9f,0x8f,0xcf,0xc7,0xc7,0xc1,0xf0,0xf0,0xf8,0xf8,0xfc,0xfe,0xff,0x7f,0x3f,0x3f,0x3f,0x1f,0x0f,0x0f,0x0f,0x07,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x07,0x07,0x0f,0x0f,0x1f,0x1f,0x3f,0x3f,0x3f,0x7f,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,0x7f,0x3f,0x3f,0x1f,0x1f,0x0f,0x0f,0x07,0x07,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

void init_display(int i2cd) {
    wiringPiI2CWriteReg8(i2cd, 0x00, 0xAE); // Display OFF

    wiringPiI2CWriteReg8(i2cd, 0x00, 0x81); // Set Contrast
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x7F); // Constrast default

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xA6); // Set Normal Display

    wiringPiI2CWriteReg8(i2cd, 0x00, 0x2E); // Deactivate Scroll

    wiringPiI2CWriteReg8(i2cd, 0x00, 0x20); // Set Memory Addressing Mode
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x00); // Set Memory Addressing Mode - Page

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xA1); // Set Segment re-map

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xA8); // Set Multiplex Ratio
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x3F); // Set Multiplex Ratio - Vertical Size - 1

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xC0); // Set COM Output Scan Direction

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xD3); // Set Display Offset
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x00); // Set Display Offset

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xDA); // Set COM Pins Hardware Configuration
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x12); // COM sequence (Split) is under command setting

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xD5); // Set Display Clock Divide Ratio
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x80); // Set Osc Frequency

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xD9); // Set Pre-charge Period
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x22); // Set Pre-charge Period

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xDB); // Set VCOMH Deselect Level
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x20); // Set VCOMH Deselect Level - ~0.77 x V CC (RESET)

    wiringPiI2CWriteReg8(i2cd, 0x00, 0x8D); // Charge charge pump regulator
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x14); // Enable charge pump regulator

    wiringPiI2CWriteReg8(i2cd, 0x00, 0xA4); // Entire Display ON
    wiringPiI2CWriteReg8(i2cd, 0x00, 0xAF); // Set Display ON
}

void refresh_display(int i2cd) {
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x21); // Set Column Address
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x00); // Set Column Address - start
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x7F); // Set Column Address - end

    wiringPiI2CWriteReg8(i2cd, 0x00, 0x22); // Set Page Address
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x00); // Set Page Address - page start address
    wiringPiI2CWriteReg8(i2cd, 0x00, 0x07); // Set Page Address - end address of the display data RAM
}

void clear_display(int i2cd) {
    wiringPiI2CWriteReg8(i2cd, 0x00, 0xAE); // Display OFF
    for (int i=0; i < BUFFER_SIZE; i++) {
        wiringPiI2CWriteReg8(i2cd, 0x40, 0x00);
    }
    wiringPiI2CWriteReg8(i2cd, 0x00, 0xA4); // Entire Display ON
    wiringPiI2CWriteReg8(i2cd, 0x00, 0xAF); // Set Display ON
}


int main(void) {
    int i2cd = 0;

    i2cd = wiringPiI2CSetup(0x3C);
    if (i2cd < 0) {
		fprintf(stderr, "Unable to initialise I2C.\n");
		return EXIT_FAILURE;
	}

    init_display(i2cd);
    refresh_display(i2cd);
    clear_display(i2cd);

    for (int i=0; i < BUFFER_SIZE; i++) {
        wiringPiI2CWriteReg8(i2cd, 0x40, buffer[i]);
    }

    return EXIT_SUCCESS;
}
